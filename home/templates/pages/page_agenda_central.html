{% extends 'layouts/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-3">
  <!-- Back button and page title -->
  <div class="row mb-3">
    <div class="col-8">
      <div class="d-flex align-items-center">
        <button type="button" class="btn bg-gradient-primary btn-sm me-3">
          <i class="fas fa-arrow-left me-1"></i>
          <a class="text-white text-decoration-none" href="{% url 'index' %}">Voltar</a>
        </button>
        <h4 class="mb-0">Agenda Central</h4>
      </div>
    </div>
    <div class="col-4 text-end">
      <button type="button" class="btn bg-gradient-info btn-sm" data-bs-toggle="modal" data-bs-target="#filterModal">
        <i class="fas fa-filter me-1"></i> Filtros
      </button>
    </div>
  </div>

  <!-- Filter Modal -->
  <div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="filterModalLabel">Filtrar Consultas</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form method="POST" action="{% url 'agenda_central' %}" id="filterForm">
            {% csrf_token %}
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="psicologa_id" class="form-control-label text-xs text-uppercase">Psicóloga</label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-user-md"></i></span>
                    <select class="form-select" id="psicologa_id" name="psicologa_id">
                      <option value="todos">Todos</option>
                      {% for psicologa in psicologas %}
                      <option value="{{psicologa.id}}" {% if filtros_aplicados.psicologa_id == psicologa.id|stringformat:"s" %}selected{% endif %}>{{psicologa.nome}}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="unidade_id" class="form-control-label text-xs text-uppercase">Unidade</label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-building"></i></span>
                    <select class="form-select" id="unidade_id" name="unidade_id">
                      <option value="todas">Todas</option>
                      {% for unidade in unidades %}
                      <option value="{{unidade.id_unidade}}" {% if filtros_aplicados.unidade_id == unidade.id_unidade|stringformat:"s" %}selected{% endif %}>{{unidade.nome_unidade}}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="horario_inicio" class="form-control-label text-xs text-uppercase">Horário Início</label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-clock"></i></span>
                    <input type="time" class="form-control" id="horario_inicio" name="horario_inicio" value="{{ filtros_aplicados.horario_inicio|default:'' }}">
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="horario_fim" class="form-control-label text-xs text-uppercase">Horário Fim</label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-clock"></i></span>
                    <input type="time" class="form-control" id="horario_fim" name="horario_fim" value="{{ filtros_aplicados.horario_fim|default:'' }}">
                  </div>
                </div>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                  <div class="form-group">
                    <label for="especialidade_id" class="form-control-label text-xs text-uppercase">Especialização</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="fas fa-brain"></i></span>
                      <select class="form-select" id="especialidade_id" name="especialidade_id">
                        <option value="todos">Todos</option>
                        {% for especialidade in especialidades %}
                        <option value="{{especialidade.id}}">{{especialidade.especialidade}}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="publico_id" class="form-control-label text-xs text-uppercase">Público</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="fas fa-users"></i></span>
                      <select class="form-select" id="publico_id" name="publico">
                        <option value="todos">Todos</option>
                        {% for publico in publicos %}
                        <option value="{{ publico.id }}">{{ publico.publico }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <a href="{% url 'agenda_central' %}" class="btn btn-outline-secondary">Limpar Filtros</a>
          <button type="submit" form="filterForm" class="btn bg-gradient-primary">Aplicar Filtros</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Psychologists legend -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header p-3">
          <div class="row align-items-center">
            <div class="col">
              <h6 class="mb-0">Legenda de Psicólogas</h6>
            </div>
            <div class="col-auto">
              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#legendaCollapse" aria-expanded="false" aria-controls="legendaCollapse">
                <i class="fas fa-chevron-down" id="legendaIcon"></i>
              </button>
            </div>
          </div>
        </div>
        <div class="collapse show" id="legendaCollapse">
          <div class="card-body p-3">
            <div class="row g-3">
              {% for psicologa in psicologas %}
                <div class="col-lg-3 col-md-4 col-sm-6">
                  <div class="d-flex align-items-center">
                    <div style="width: 20px; height: 20px; background-color: {{ psicologa.cor }}; border-radius: 50%; margin-right: 10px;"></div>
                    <span class="text-sm">{{ psicologa.nome }}</span>
                  </div>
                </div>
              {% empty %}
                <div class="col-12 text-center py-3">
                  <p class="text-muted mb-0">Nenhuma psicóloga cadastrada no sistema.</p>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs compactas -->
  <div class="row mb-2">
    <div class="col-12">
      <ul class="nav nav-tabs nav-fill" id="modeTab" role="tablist" style="font-size: 0.9rem;">
        <li class="nav-item" role="presentation">
          <button class="nav-link active py-2" id="presencial-tab" data-bs-toggle="tab" data-bs-target="#presencial-tab-pane" type="button" role="tab">
            <i class="fas fa-building me-1"></i>Presencial
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link py-2" id="online-tab" data-bs-toggle="tab" data-bs-target="#online-tab-pane" type="button" role="tab">
            <i class="fas fa-laptop me-1"></i>Online
          </button>
        </li>
      </ul>
    </div>
  </div>

  <!-- Tab content -->
  <div class="tab-content" id="modeTabContent">
    <!-- Presencial Tab -->
    <div class="tab-pane fade show active" id="presencial-tab-pane" role="tabpanel" aria-labelledby="presencial-tab">
      
      <!-- Layout por unidade e sala -->
      {% for sala in salas %}
      <div class="card mb-4 shadow-sm">
        <!-- Cabeçalho da sala -->
        <div class="card-header py-2 px-3" style="background: linear-gradient(45deg, {{ sala.cor_sala }}, {{ sala.cor_sala }}dd); color: white;">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              <h6 class="mb-0 fw-bold">UNIDADE {{ sala.id_unidade.nome_unidade|upper }}</h6>
              <span class="mx-3">|</span>
              <h6 class="mb-0 fw-bold">SALA {{ sala.numero_sala }}</h6>
            </div>
            <small class="opacity-75">{{ sala.id_unidade.nome_unidade }}</small>
          </div>
        </div>

        <!-- Container dos dias da semana em grid -->
        <div class="card-body p-3">
          <div class="row g-2">
            {% for dia, cor in dias_cores %}
            <div class="col-md-6 col-lg-4 col-xl-2">
              <div class="card day-card">
                <div class="card-header {{ cor }} text-white text-center py-1">
                  <h6 class="mb-0 fw-bold">{{ dia|upper }}</h6>
                </div>
                <div class="card-body p-0">
                  <table class="table table-sm table-bordered mb-0 day-table">
                    <thead>
                      <tr>
                        <th class="text-center text-xs">Horário</th>
                        <th class="text-center text-xs">Semanal</th>
                        <th class="text-center text-xs">Quinzenal</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for horario_linha in horarios_unicos %}
                      <tr>
                        <td class="time-cell">{{ horario_linha|time:"H:i" }}</td>
                        {% with encontrado=False %}
                          {% for consulta in consultas %}
                            {% if consulta.sala == sala and consulta.dia_semana == dia and consulta.horario == horario_linha %}
                              {% if consulta.psicologo %}
                                  {% if consulta.semanal != "Semanal" %}
                                  <td class="patient-cell" style="background-color: {{ consulta.psicologo.cor }}20;">
                                    <span class="patient-name">{{ consulta.semanal }}</span>
                                  </td>
                                  {% else %}
                                  <td class="patient-cell" style="background-color: {{ consulta.psicologo.cor }}20;">
                                    <span class="patient-name"></span>
                                  </td>
                                  {% endif %}
                                  {% if consulta.quinzenal != "Quinzenal" %}
                                  <td class="patient-cell" style="background-color: {{ consulta.psicologo.cor }}20;">
                                    <span class="patient-name">{{ consulta.quinzenal }}</span>
                                  </td>
                                  {% else %}
                                  <td class="patient-cell" style="background-color: {{ consulta.psicologo.cor }}20;">
                                    <span class="patient-name"></span>
                                  </td>
                                  {% endif %}
                              {% else %}
                                <td class="patient-cell">-</td>
                                <td class="patient-cell">-</td>
                              {% endif %}
                              {% with encontrado=True %}{% endwith %}
                            {% endif %}
                          {% endfor %}
                          {% if not encontrado %}
                            <td class="patient-cell">-</td>
                            <td class="patient-cell">-</td>
                          {% endif %}
                        {% endwith %}
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% empty %}
      <div class="alert alert-info" role="alert">
        <div class="d-flex">
          <div class="me-3">
            <i class="fas fa-info-circle fa-2x"></i>
          </div>
          <div>
            <h6 class="alert-heading mb-1">Nenhuma sala encontrada</h6>
            <p class="mb-0">Não existem salas cadastradas ou que correspondam aos filtros selecionados.</p>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Online Tab -->
    <div class="tab-pane fade" id="online-tab-pane" role="tabpanel" aria-labelledby="online-tab">
      {% for psicologa in psicologas_online %}
      <div class="card mb-4 shadow-sm">
        <div class="card-header py-2 px-3" style="background: linear-gradient(45deg, {{ psicologa.cor }}, {{ psicologa.cor }}dd); color: white;">
          <div class="d-flex align-items-center">
            <h6 class="mb-0 fw-bold">{{ psicologa.nome|upper }} - ATENDIMENTO ONLINE</h6>
          </div>
        </div>
        
        <!-- Container dos dias da semana para atendimento online -->
        <div class="card-body p-3">
          <div class="row g-2">
            {% for dia, cor in dias_cores %}
            <div class="col-md-6 col-lg-4 col-xl-2">
              <div class="card day-card">
                <div class="card-header {{ cor }} text-white text-center py-1">
                  <h6 class="mb-0 fw-bold">{{ dia|upper }}</h6>
                </div>
                <div class="card-body p-0">
                  <table class="table table-sm table-bordered mb-0 day-table">
                    <thead>
                      <tr>
                        <th class="text-center text-xs">Horário</th>
                        <th class="text-center text-xs">Semanal</th>
                        <th class="text-center text-xs">Quinzenal</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for horario_linha in horarios_unicos_online %}
                      <tr>
                        <td class="time-cell">{{ horario_linha|time:"H:i" }}</td>
                        {% with encontrado=False %}
                          {% for consulta in consultas_online %}
                            {% if consulta.psicologo == psicologa and consulta.dia_semana == dia and consulta.horario == horario_linha %}
                              {% if consulta.semanal != "Semanal" %}
                                  <td class="patient-cell" style="background-color: {{ consulta.psicologo.cor }}20;">
                                    <span class="patient-name">{{ consulta.semanal }}</span>
                                  </td>
                                  {% else %}
                                  <td class="patient-cell" style="background-color: {{ consulta.psicologo.cor }}20;">
                                    <span class="patient-name"></span>
                                  </td>
                                  {% endif %}
                                  {% if consulta.quinzenal != "Quinzenal" %}
                                  <td class="patient-cell" style="background-color: {{ consulta.psicologo.cor }}20;">
                                    <span class="patient-name">{{ consulta.quinzenal }}</span>
                                  </td>
                                  {% else %}
                                  <td class="patient-cell" style="background-color: {{ consulta.psicologo.cor }}20;">
                                    <span class="patient-name"></span>
                                  </td>
                                  {% endif %}
                              {% with encontrado=True %}{% endwith %}
                            {% endif %}
                          {% endfor %}
                          {% if not encontrado %}
                            <td class="patient-cell">-</td>
                            <td class="patient-cell">-</td>
                          {% endif %}
                        {% endwith %}
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% empty %}
      <div class="alert alert-info" role="alert">
        <div class="d-flex">
          <div class="me-3">
            <i class="fas fa-info-circle fa-2x"></i>
          </div>
          <div>
            <h6 class="alert-heading mb-1">Nenhuma agenda online encontrada</h6>
            <p class="mb-0">Não existem agendas online cadastradas.</p>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Paginação -->
  <div class="row mt-3">
    <div class="col-12">
      <nav aria-label="Navegação de páginas">
        <ul class="pagination justify-content-center pagination-sm">
          {% if salas.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page=1{% for key, value in filtros_aplicados.items %}&{{ key }}={{ value }}{% endfor %}">««</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ salas.previous_page_number }}{% for key, value in filtros_aplicados.items %}&{{ key }}={{ value }}{% endfor %}">‹</a>
            </li>
          {% endif %}

          {% for num in salas.paginator.page_range %}
            {% if salas.number == num %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > salas.number|add:'-3' and num < salas.number|add:'3' %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% for key, value in filtros_aplicados.items %}&{{ key }}={{ value }}{% endfor %}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {% if salas.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ salas.next_page_number }}{% for key, value in filtros_aplicados.items %}&{{ key }}={{ value }}{% endfor %}">›</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ salas.paginator.num_pages }}{% for key, value in filtros_aplicados.items %}&{{ key }}={{ value }}{% endfor %}">»»</a>
            </li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>
</div>

<!-- CSS Personalizado -->
<style>
/* ==================== ESTILOS PARA AS TABELAS DA AGENDA ==================== */

/* Estilo das tabelas de dias da semana */
.day-card {
  border: 1px solid #dee2e6;
  border-radius: 8px;
  overflow: hidden;
  height: 100%;
  min-height: 400px;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.day-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.day-table {
  font-size: 10px;
  border-collapse: collapse;
}

.day-table th,
.day-table td {
  border: 1px solid #dee2e6 !important;
  padding: 4px 6px !important;
  vertical-align: middle;
  text-align: center;
}

.day-table th {
  background-color: #f8f9fa;
  font-weight: 600;
  font-size: 9px;
  color: #6c757d;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.time-cell {
  background-color: #f8f9fa !important;
  font-weight: 600;
  color: #495057;
  font-size: 9px;
  min-width: 50px;
}

.patient-cell {
  position: relative;
  padding: 6px 4px !important;
  min-height: 35px;
  transition: background-color 0.2s ease;
}

.patient-cell:hover {
  opacity: 0.8;
  cursor: pointer;
}

.patient-name {
  font-size: 8px;
  font-weight: 500;
  color: #495057;
  word-wrap: break-word;
  line-height: 1.2;
  display: block;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Cores dos cabeçalhos dos dias */
.bg-primary { background-color: #007bff !important; }
.bg-success { background-color: #28a745 !important; }
.bg-warning { background-color: #ffc107 !important; }
.bg-info { background-color: #17a2b8 !important; }
.bg-secondary { background-color: #6c757d !important; }
.bg-dark { background-color: #343a40 !important; }

/* ==================== RESPONSIVIDADE ==================== */

/* Tablets e telas médias */
@media (max-width: 1200px) {
  .day-card {
    min-height: 350px;
  }
  
  .day-table {
    font-size: 9px;
  }
  
  .patient-name {
    font-size: 7px;
  }
}

/* Mobile e telas pequenas */
@media (max-width: 768px) {
  .day-card {
    min-height: 300px;
    margin-bottom: 15px;
  }
  
  .day-table th,
  .day-table td {
    padding: 3px 2px !important;
  }
  
  .day-table {
    font-size: 8px;
  }
  
  .patient-name {
    font-size: 6px;
  }
  
  .time-cell {
    min-width: 40px;
  }
}

/* ==================== ESTILOS PARA FILTROS E MODAIS ==================== */

.modal-header {
  background: linear-gradient(45deg, #007bff, #0056b3);
  color: white;
}

.modal-header .btn-close {
  filter: invert(1);
}

.form-control:focus, 
.form-select:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.input-group-text {
  background-color: #f8f9fa;
  border-color: #ced4da;
  color: #6c757d;
}

/* ==================== ESTILOS PARA LEGENDA ==================== */

.card-header .btn {
  transition: transform 0.2s ease;
}

.card-header .btn:hover {
  transform: scale(1.05);
}

#legendaIcon {
  transition: transform 0.3s ease;
}

#legendaCollapse.show #legendaIcon {
  transform: rotate(180deg);
}

/* ==================== ESTILOS PARA PAGINAÇÃO ==================== */

.pagination .page-link {
  color: #007bff;
  border-color: #dee2e6;
  padding: 0.375rem 0.75rem;
  font-size: 0.875rem;
}

.pagination .page-link:hover {
  background-color: #e9ecef;
  border-color: #dee2e6;
}

.pagination .page-item.active .page-link {
  background-color: #007bff;
  border-color: #007bff;
}

/* ==================== ESTILOS PARA TABS ==================== */

.nav-tabs .nav-link {
  border-radius: 0.5rem 0.5rem 0 0;
  margin-right: 2px;
  transition: all 0.2s ease;
}

.nav-tabs .nav-link:hover {
  border-color: #e9ecef #e9ecef #dee2e6;
  background-color: #f8f9fa;
}

.nav-tabs .nav-link.active {
  background-color: #fff;
  border-color: #dee2e6 #dee2e6 #fff;
  color: #007bff;
  font-weight: 600;
}

/* ==================== ANIMAÇÕES E TRANSIÇÕES ==================== */

.card {
  transition: all 0.3s ease;
}

.card:hover {
  box-shadow: 0 4px 25px rgba(0, 0, 0, 0.1);
}

.btn {
  transition: all 0.2s ease;
}

.btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

/* ==================== ESTILOS PARA ALERTAS ==================== */

.alert-info {
  border: none;
  border-radius: 10px;
  background: linear-gradient(45deg, #d1ecf1, #bee5eb);
  border-left: 4px solid #17a2b8;
}

.alert-info .fa-info-circle {
  color: #17a2b8;
}

/* ==================== LOADING STATES ==================== */

.loading {
  opacity: 0.6;
  pointer-events: none;
}

.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  margin: -10px 0 0 -10px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid #007bff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ==================== PRINT STYLES ==================== */

@media print {
  .btn, .pagination, .modal, .nav-tabs {
    display: none !important;
  }
  
  .day-card {
    break-inside: avoid;
    margin-bottom: 10px;
  }
  
  .card-body {
    padding: 10px !important;
  }
  
  .day-table {
    font-size: 8px;
  }
}
</style>

<!-- JavaScript Personalizado -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // ==================== INICIALIZAÇÃO ==================== //
    
    console.log('Agenda Central - Sistema carregado');
    
    // ==================== CONTROLE DE COLLAPSE DA LEGENDA ==================== //
    
    const legendaCollapse = document.getElementById('legendaCollapse');
    const legendaIcon = document.getElementById('legendaIcon');
    
    if (legendaCollapse && legendaIcon) {
        legendaCollapse.addEventListener('show.bs.collapse', function() {
            legendaIcon.style.transform = 'rotate(180deg)';
        });
        
        legendaCollapse.addEventListener('hide.bs.collapse', function() {
            legendaIcon.style.transform = 'rotate(0deg)';
        });
    }
    
    // ==================== FUNCIONALIDADE DE FILTROS ==================== //
    
    const filterForm = document.getElementById('filterForm');
    const filterModal = document.getElementById('filterModal');
    
    if (filterForm) {
        // Limpeza automática de filtros conflitantes
        const horarioInicio = document.getElementById('horario_inicio');
        const horarioFim = document.getElementById('horario_fim');
        
        if (horarioInicio && horarioFim) {
            horarioInicio.addEventListener('change', function() {
                if (horarioFim.value && this.value > horarioFim.value) {
                    horarioFim.value = this.value;
                    showNotification('Horário de fim ajustado automaticamente', 'warning');
                }
            });
            
            horarioFim.addEventListener('change', function() {
                if (horarioInicio.value && this.value < horarioInicio.value) {
                    horarioInicio.value = this.value;
                    showNotification('Horário de início ajustado automaticamente', 'warning');
                }
            });
        }
        
        // Submit do formulário com loading
        filterForm.addEventListener('submit', function() {
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Aplicando...';
                submitBtn.disabled = true;
            }
            
            // Adiciona loading state ao container principal
            const mainContainer = document.querySelector('.container-fluid');
            if (mainContainer) {
                mainContainer.classList.add('loading');
            }
        });
    }
    
    // ==================== TOOLTIPS E POPOVERS ==================== //
    
    // Inicializar tooltips para células de pacientes
    initializeTooltips();
    
    // Tooltip para células com nomes de pacientes
    function initializeTooltips() {
        const patientCells = document.querySelectorAll('.patient-cell');
        patientCells.forEach(function(cell) {
            const patientName = cell.querySelector('.patient-name');
            if (patientName && patientName.textContent.trim() !== '-') {
                cell.setAttribute('data-bs-toggle', 'tooltip');
                cell.setAttribute('data-bs-placement', 'top');
                cell.setAttribute('title', 'Paciente: ' + patientName.textContent.trim());
            }
        });
        
        // Inicializar Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
    
    // ==================== NAVEGAÇÃO ENTRE TABS ==================== //
    
    const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
    tabButtons.forEach(function(tab) {
        tab.addEventListener('shown.bs.tab', function(e) {
            const targetTab = e.target.getAttribute('data-bs-target');
            console.log('Tab ativa:', targetTab);
            
            // Salvar preferência de tab no localStorage
            try {
                localStorage.setItem('agendaCentral_activeTab', targetTab);
            } catch(e) {
                console.log('LocalStorage não disponível');
            }
            
            // Reinicializar tooltips na nova tab
            setTimeout(function() {
                initializeTooltips();
            }, 100);
        });
    });
    
    // Restaurar tab ativa do localStorage
    try {
        const savedTab = localStorage.getItem('agendaCentral_activeTab');
        if (savedTab) {
            const tabElement = document.querySelector('[data-bs-target="' + savedTab + '"]');
            if (tabElement) {
                const tab = new bootstrap.Tab(tabElement);
                tab.show();
            }
        }
    } catch(e) {
        console.log('LocalStorage não disponível para restaurar tab');
    }
    
    // ==================== FUNCIONALIDADES DE BUSCA RÁPIDA ==================== //
    
    // Adicionar campo de busca rápida por psicóloga
    // addQuickSearch();
    
    // function addQuickSearch() {
    //     const legendaCard = document.querySelector('.card-header .row .col');
    //     if (legendaCard) {
    //         const searchContainer = document.createElement('div');
    //         searchContainer.className = 'col-auto';
    //         searchContainer.innerHTML = `
    //             <div class="input-group input-group-sm" style="width: 200px;">
    //                 <span class="input-group-text"><i class="fas fa-search"></i></span>
    //                 <input type="text" class="form-control" id="quickSearchPsico" placeholder="Buscar psicóloga...">
    //             </div>
    //         `;
            
    //         legendaCard.parentElement.appendChild(searchContainer);
            
    //         // Funcionalidade de busca
    //         const searchInput = document.getElementById('quickSearchPsico');
    //         if (searchInput) {
    //             searchInput.addEventListener('input', function() {
    //                 filterPsicologaLegend(this.value.toLowerCase());
    //             });
    //         }
    //     }
    // }
    
    function filterPsicologaLegend(searchTerm) {
        const psicologaItems = document.querySelectorAll('#legendaCollapse .col-lg-3, #legendaCollapse .col-md-4, #legendaCollapse .col-sm-6');
        
        psicologaItems.forEach(function(item) {
            const nameElement = item.querySelector('.text-sm');
            if (nameElement) {
                const name = nameElement.textContent.toLowerCase();
                if (name.includes(searchTerm)) {
                    item.style.display = '';
                    item.style.order = '0';
                } else {
                    item.style.display = 'none';
                }
            }
        });
    }
    
    // ==================== HIGHLIGHT DE CÉLULAS POR PSICÓLOGA ==================== //
    
    // Adicionar funcionalidade de highlight ao clicar na legenda
    const psicologaLegendItems = document.querySelectorAll('#legendaCollapse .d-flex');
    psicologaLegendItems.forEach(function(item) {
        item.style.cursor = 'pointer';
        item.addEventListener('click', function() {
            const psicologaName = this.querySelector('.text-sm').textContent.trim();
            highlightPsicologaCells(psicologaName);
        });
    });
    
    function highlightPsicologaCells(psicologaName) {
        // Remover highlight anterior
        document.querySelectorAll('.patient-cell-highlighted').forEach(function(cell) {
            cell.classList.remove('patient-cell-highlighted');
        });
        
        // Adicionar novo highlight
        const patientCells = document.querySelectorAll('.patient-cell');
        let highlightCount = 0;
        
        patientCells.forEach(function(cell) {
            const patientSpan = cell.querySelector('.patient-name');
            if (patientSpan && patientSpan.textContent.trim() !== '-') {
                // Aqui você pode implementar a lógica para verificar se a célula pertence à psicóloga
                // Por enquanto, vamos usar a cor de fundo como indicador
                const cellStyle = window.getComputedStyle(cell);
                if (cellStyle.backgroundColor !== 'rgba(0, 0, 0, 0)') {
                    cell.classList.add('patient-cell-highlighted');
                    highlightCount++;
                }
            }
        });
        
        showNotification(`${highlightCount} consultas destacadas para ${psicologaName}`, 'info');
        
        // Remover highlight após 5 segundos
        setTimeout(function() {
            document.querySelectorAll('.patient-cell-highlighted').forEach(function(cell) {
                cell.classList.remove('patient-cell-highlighted');
            });
        }, 5000);
    }
    
    // ==================== SISTEMA DE NOTIFICAÇÕES ==================== //
    
    function showNotification(message, type = 'info') {
        // Remove notificação anterior se existir
        const existingNotification = document.querySelector('.custom-notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} custom-notification`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            animation: slideInRight 0.3s ease;
        `;
        
        notification.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-${getIconForType(type)} me-2"></i>
                <span>${message}</span>
                <button type="button" class="btn-close ms-auto" aria-label="Close"></button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Fechar ao clicar no X
        notification.querySelector('.btn-close').addEventListener('click', function() {
            notification.remove();
        });
        
        // Auto-remover após 4 segundos
        setTimeout(function() {
            if (notification && notification.parentNode) {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(function() {
                    notification.remove();
                }, 300);
            }
        }, 4000);
    }
    
    function getIconForType(type) {
        const icons = {
            'success': 'check-circle',
            'error': 'exclamation-circle',
            'warning': 'exclamation-triangle',
            'info': 'info-circle'
        };
        return icons[type] || 'info-circle';
    }
    
    // ==================== KEYBOARD SHORTCUTS ==================== //
    
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + F para focar no filtro
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            const searchInput = document.getElementById('quickSearchPsico');
            if (searchInput) {
                searchInput.focus();
                searchInput.select();
            }
        }
        
        // Ctrl/Cmd + 1/2 para alternar entre tabs
        if ((e.ctrlKey || e.metaKey) && (e.key === '1' || e.key === '2')) {
            e.preventDefault();
            const tabId = e.key === '1' ? 'presencial-tab' : 'online-tab';
            const tab = document.getElementById(tabId);
            if (tab) {
                tab.click();
            }
        }
        
        // ESC para fechar modal
        if (e.key === 'Escape') {
            const openModal = document.querySelector('.modal.show');
            if (openModal) {
                const modalInstance = bootstrap.Modal.getInstance(openModal);
                if (modalInstance) {
                    modalInstance.hide();
                }
            }
        }
    });
    
    // ==================== FUNCIONALIDADES DE PRINT ==================== //
    
    // Adicionar botão de impressão
    // addPrintButton();
    
    // function addPrintButton() {
    //     const titleRow = document.querySelector('.row.mb-3 .col-4');
    //     if (titleRow) {
    //         const printBtn = document.createElement('button');
    //         printBtn.className = 'btn bg-gradient-secondary btn-sm me-2';
    //         printBtn.innerHTML = '<i class="fas fa-print me-1"></i> Imprimir';
    //         printBtn.addEventListener('click', function() {
    //             window.print();
    //         });
            
    //         titleRow.insertBefore(printBtn, titleRow.firstChild);
    //     }
    // }
    
    // ==================== FUNCIONALIDADES DE ACESSIBILIDADE ==================== //
    
    // Melhorar acessibilidade com navegação por teclado
    const dayCards = document.querySelectorAll('.day-card');
    dayCards.forEach(function(card, index) {
        card.setAttribute('tabindex', '0');
        card.setAttribute('role', 'grid');
        card.setAttribute('aria-label', 'Agenda do dia ' + card.querySelector('.card-header h6').textContent);
        
        card.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                card.querySelector('table').focus();
            }
        });
    });
    
    // ==================== LAZY LOADING PARA PERFORMANCE ==================== //
    
    // Implementar lazy loading para tabs não ativas
    const tabPanes = document.querySelectorAll('.tab-pane');
    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
            if (entry.isIntersecting) {
                entry.target.classList.add('loaded');
                // Aqui você pode carregar conteúdo adicional se necessário
            }
        });
    });
    
    tabPanes.forEach(function(pane) {
        observer.observe(pane);
    });
    
    // ==================== FUNCIONALIDADES DE EXPORT ==================== //
    
    // Adicionar botão de exportação para CSV/Excel
    // addExportButton();
    
    // function addExportButton() {
    //     const titleRow = document.querySelector('.row.mb-3 .col-4');
    //     if (titleRow) {
    //         const exportBtn = document.createElement('button');
    //         exportBtn.className = 'btn bg-gradient-success btn-sm me-2';
    //         exportBtn.innerHTML = '<i class="fas fa-download me-1"></i> Exportar';
    //         exportBtn.addEventListener('click', function() {
    //             exportToCSV();
    //         });
            
    //         titleRow.insertBefore(exportBtn, titleRow.firstChild);
    //     }
    // }
    
    function exportToCSV() {
        const activeTab = document.querySelector('.tab-pane.active');
        const tables = activeTab.querySelectorAll('.day-table');
        
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Unidade,Sala,Dia,Horário,Tipo,Paciente\n";
        
        tables.forEach(function(table) {
            const dayCard = table.closest('.day-card');
            const dayName = dayCard.querySelector('.card-header h6').textContent;
            const salaCard = table.closest('.card.mb-4');
            const salaInfo = salaCard.querySelector('.card-header h6').textContent;
            
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(function(row) {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 3) {
                    const horario = cells[0].textContent.trim();
                    const semanal = cells[1].textContent.trim();
                    const quinzenal = cells[2].textContent.trim();
                    
                    if (semanal !== '-') {
                        csvContent += `"${salaInfo}","${dayName}","${horario}","Semanal","${semanal}"\n`;
                    }
                    if (quinzenal !== '-') {
                        csvContent += `"${salaInfo}","${dayName}","${horario}","Quinzenal","${quinzenal}"\n`;
                    }
                }
            });
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "agenda_central_" + new Date().toISOString().split('T')[0] + ".csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Agenda exportada com sucesso!', 'success');
    }
    
    // ==================== AUTO-REFRESH (OPCIONAL) ==================== //
    
    // Auto-refresh a cada 5 minutos (comentado por padrão)
    /*
    setInterval(function() {
        if (document.visibilityState === 'visible') {
            showNotification('Atualizando dados...', 'info');
            setTimeout(function() {
                location.reload();
            }, 1000);
        }
    }, 300000); // 5 minutos
    */
    
    // ==================== FINALIZAÇÃO ==================== //
    
    console.log('Agenda Central - Todos os scripts carregados com sucesso');
    // showNotification('Sistema carregado com sucesso!', 'success');
    
}); // Fim do DOMContentLoaded

// ==================== ESTILOS ADICIONAIS PARA ANIMAÇÕES ==================== //

const additionalStyles = `
    <style>
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    .patient-cell-highlighted {
        animation: pulse 2s infinite;
        border: 2px solid #007bff !important;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
        }
    }
    
    .day-card:focus {
        outline: 2px solid #007bff;
        outline-offset: 2px;
    }
    
    .custom-notification {
        animation: slideInRight 0.3s ease;
    }
    
    /* Melhorias de performance */
    .day-table {
        will-change: transform;
    }
    
    .patient-cell {
        will-change: background-color;
    }
    
    /* Estados de loading melhorados */
    .loading .day-card {
        position: relative;
        overflow: hidden;
    }
    
    .loading .day-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: shimmer 1.5s infinite;
        z-index: 1;
    }
    
    @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
    }
    </style>
`;

document.head.insertAdjacentHTML('beforeend', additionalStyles);
</script>

{% endblock %}